<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IvInfo</title>
</head>
<body>
<div class="page type-interior pluginConfigurationPage configPage" data-require="emby-input,emby-button,emby-checkbox"
     data-role="page">
    <div data-role="content">
        <div class="content-primary">
            <form class="configForm">
                <fieldset>
                    <legend>Global configuration</legend>
                    <label class="checkboxContainer">
                        <input id="firstOnly" is="emby-checkbox" type="checkbox"/>
                        <span>Pick first result for multiple results found</span>
                    </label>
                </fieldset>
                <br/>
                <fieldset>
                    <legend>Enabled scrapers</legend>
                    <label class="checkboxContainer">
                        <input id="javlibrary" is="emby-checkbox" type="checkbox"/>
                        <span>Javlibrary scraper</span>
                    </label>
                    <label class="checkboxContainer">
                        <input id="dmm" is="emby-checkbox" type="checkbox"/>
                        <span>DMM scraper</span>
                    </label>
                    <div id="dmm_proxy_container" style="padding-left: 1em;">
                        <label class="checkboxContainer">
                            <input id="dmm_proxy" is="emby-checkbox" type="checkbox"/>
                            <span>Use proxy for DMM scraper</span>
                        </label>
                    </div>
                    <label class="checkboxContainer">
                        <input id="gekiyasu" is="emby-checkbox" type="checkbox"/>
                        <span>Gekiyasu scraper</span>
                    </label>
                </fieldset>
                <br/>
                <fieldset>
                    <legend>Enabled image scrapers</legend>
                    <label class="checkboxContainer">
                        <input id="javlibrary_img" is="emby-checkbox" type="checkbox"/>
                        <span>Javlibrary</span>
                    </label>
                    <label class="checkboxContainer">
                        <input id="dmm_img" is="emby-checkbox" type="checkbox"/>
                        <span>DMM</span>
                    </label>
                    <label class="checkboxContainer">
                        <input id="gekiyasu_img" is="emby-checkbox" type="checkbox"/>
                        <span>Gekiyasu</span>
                    </label>
                </fieldset>
                <fieldset>
                    <legend>Scrapers priority (top one is queried first)</legend>
                    <div class="paperList" id="priority">
                        <div class="listItem" data-id="javlib" data-value="1" id="prio_javlib">
                            <span class="material-icons drag_indicator"></span>
                            <div class="listItemBody">
                                <div class="listItemBodyText">Javlibrary</div>
                            </div>
                        </div>
                        <div class="listItem" data-id="dmm" data-value="2" id="prio_dmm">
                            <span class="material-icons drag_indicator"></span>
                            <div class="listItemBody">
                                <div class="listItemBodyText">DMM</div>
                            </div>
                        </div>
                        <div class="listItem" data-id="geki" data-value="3" id="prio_geki">
                            <span class="material-icons drag_indicator"></span>
                            <div class="listItemBody">
                                <div class="listItemBodyText">Gekiyasu</div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <div>
                    <button class="raised button-submit block" is="emby-button" type="submit"><span>Save</span></button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://SortableJS.github.io/Sortable/Sortable.js"></script>
    <script type="text/javascript">
        const PluginConfig = {
            pluginId: "abe0c619-a145-4890-896b-cb1089ade4fe"
        };

        console.log("Start");

        document.querySelector('#dmm')
            .addEventListener('click', function () {
                const enabled = document.querySelector("#dmm").checked;
                const cb = document.querySelector('#dmm_proxy');
                const div = document.querySelector('#dmm_proxy_container');
                cb.checked = enabled;
                cb.disabled = !enabled;
                div.classList.toggle('hide', cb.disabled);
            });

        document.querySelector('.configPage')
            .addEventListener('pageshow', function () {
                console.log("start");
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(PluginConfig.pluginId).then(function (config) {
                    document.querySelector('#firstOnly').checked = config.FirstOnly;
                    document.querySelector('#javlibrary').checked = config.JavlibraryScraperEnabled;
                    document.querySelector('#dmm').checked = config.DmmScraperEnabled;
                    document.querySelector('#gekiyasu').checked = config.GekiyasuScraperEnabled;
                    document.querySelector('#javlibrary_img').checked = config.JavlibraryImgEnabled;
                    document.querySelector('#dmm_img').checked = config.DmmImgEnabled;
                    document.querySelector('#gekiyasu_img').checked = config.GekiyasuImgEnabled;
                    document.querySelector('#dmm_proxy').checked = config.DmmUseProxy;
                    document.querySelector('#prio_javlib').setAttribute('data-value', config.JavLibraryScraperPriority);
                    document.querySelector('#prio_dmm').setAttribute('data-value', config.DmmScraperPriority);
                    document.querySelector('#prio_geki').setAttribute('data-value', config.GekiyasuScraperPriority);
                    Dashboard.hideLoadingMsg();
                });
                setTimeout(() => {
                    const el = document.getElementById('priority');
                    Sortable.create(el, {
                        store: {
                            get: () => {
                                const order = [];
                                order[document.querySelector('#prio_javlib').getAttribute('data-value') - 1] = 'javlib';
                                order[document.querySelector('#prio_dmm').getAttribute('data-value') - 1] = 'dmm';
                                order[document.querySelector('#prio_geki').getAttribute('data-value') - 1] = 'geki';
                                return order;
                            },
                            set: (sortable) => {
                                const order = sortable.toArray();
                                document.querySelector('#prio_javlib').setAttribute('data-value', order.indexOf('javlib') + 1);
                                document.querySelector('#prio_dmm').setAttribute('data-value', order.indexOf('dmm') + 1);
                                document.querySelector('#prio_geki').setAttribute('data-value', order.indexOf('geki') + 1);
                            }
                        }
                    });
                }, 500);
            });

        document.querySelector('.configForm')
            .addEventListener('submit', function (e) {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(PluginConfig.pluginId).then(function (config) {
                    config.FirstOnly = document.querySelector('#firstOnly').checked;
                    config.JavlibraryScraperEnabled = document.querySelector('#javlibrary').checked;
                    config.DmmScraperEnabled = document.querySelector('#dmm').checked;
                    config.GekiyasuScraperEnabled = document.querySelector('#gekiyasu').checked;
                    config.JavlibraryImgEnabled = document.querySelector('#javlibrary_img').checked;
                    config.DmmImgEnabled = document.querySelector('#dmm_img').checked;
                    config.GekiyasuImgEnabled = document.querySelector('#gekiyasu_img').checked;
                    config.DmmUseProxy = document.querySelector('#dmm_proxy').checked;
                    config.JavLibraryScraperPriority = document.querySelector('#prio_javlib').getAttribute('data-value') + 1;
                    config.DmmScraperPriority = document.querySelector('#prio_dmm').getAttribute('data-value') + 1;
                    config.GekiyasuScraperPriority = document.querySelector('#prio_geki').getAttribute('data-value') + 1;
                    ApiClient.updatePluginConfiguration(PluginConfig.pluginId, config).then(Dashboard.processPluginConfigurationUpdateResult);
                });

                e.preventDefault();
                return false;
            });

    </script>
</div>
</body>
</html>